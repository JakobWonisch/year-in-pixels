<!DOCTYPE html>
<html lang="en">

<head>
  <title>Year In Pixels</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/SebastianAigner/twemoji-amazing/twemoji-amazing.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=VT323&amp;family=Vujahday+Script&amp;display=swap">
  <link rel="icon" type="image/png" sizes="196x196" href="icons/favicon-196.png">
  <link rel="apple-touch-icon" href="icons/apple-icon-180.png">
  <link rel="manifest" href="manifest.json">
  <!-- Fathom - beautiful, simple website analytics -->
  <!-- <script src="https://cdn.usefathom.com/script.js" data-site="XUHUMFJO" defer></script> -->
  <!-- / Fathom -->
  <script src="https://unpkg.com/hyperscript.org@0.9.3"></script>
  <script type="text/hyperscript">
      behavior Pixel -- When a pixel is clicked, it gets selected.
        on click
          remove .border-2 .border-dark .rounded .border from .border 
          add .border-2 .border-dark .rounded .border to me.children 
        end
      end
      behavior Color(c) -- When a color is clicked, it updates the selected pixel.
        on click
          remove .color-0 .color-1 .color-2 .color-3 .color-4 .color-5 .color-6 .color-7 .color-8 .color-9 .color-10 from .border
          add .{'color-' + c} to .border
          set .border@data-color to c
          call save()
        end
      end
      behavior Year(d) -- When year is changed
        on click
          call changeYear(d)
        end
      end
      behavior Category(d) -- When category is changed
        on click
          call changeCategory(d)
        end
      end
      behavior EditCategory
        on click
          set #category-edit.value to #category.innerText
          call bootstrap.Modal.getOrCreateInstance(#edit-category-modal).show()
          wait for shown.bs.modal from #edit-category-modal
          then focus() on #category-edit
        end
      end
    </script>
  <style>
    body {
      font-family: 'VT323', monospace;
      font-size: 1em;
    }

    h1 {
      font-size: 2.5em;
    }

    .clickable {
      cursor: pointer;
    }

    .clickable:hover {
      opacity: 0.75;
    }

    .days>span {
      height: 1.636em;
    }

    .bg-blend-multiply {
      background-blend-mode: multiply;
    }

    .icon {
      display: inline-block;
      height: 1em;
      width: 1em;
      margin: 0 .05em 0 .1em;
      vertical-align: -0.1em;
      background-repeat: no-repeat;
      background-position: center center;
      background-size: 1em 1em;
      height: 1.33em;
      width: 1.33em;
      margin: 0 0.0665em 0 0.133em;
      vertical-align: -0.133em;
      background-size: 1.33em 1.33em;
    }

    .icon-2xl {
      height: 2em;
      width: 2em;
      margin: 0 0.1em 0 0.2em;
      vertical-align: -0.2em;
      background-size: 2em 2em;
    }

    .color-0 {
      background-color: #ECEDED;
    }

    .color-1 {
      background-color: #fbf8cc;
    }

    .color-2 {
      background-color: #fde4cf;
    }

    .color-3 {
      background-color: #ffcfd2;
    }

    .color-4 {
      background-color: #f1c0e8;
    }

    .color-5 {
      background-color: #cfbaf0;
    }

    .color-6 {
      background-color: #a3c4f3;
    }

    .color-7 {
      background-color: #90dbf4;
    }

    .color-8 {
      background-color: #8eecf5;
    }

    .color-9 {
      background-color: #98f5e1;
    }

    .color-10 {
      background-color: #b9fbc0;
    }
  </style>

  <script src="./datasource.js"></script>
  <script src="./state.js"></script>
</head>

<body>
  <h1 class="text-center my-4">Year In Pixels</h1>
  <div class="d-flex flex-row align-items-center justify-content-center gap-3">
    <div _="install Year(d: -1)" class="clickable">⇠</div>
    <h2 id="title">XXXX</h2>
    <div _="install Year(d: 1)" class="clickable">⇢</div>
  </div>
  <div class="d-flex flex-row align-items-center justify-content-center gap-3">
    <div _="install Category(d: -1)" class="clickable">⇠</div>
    <h3 id="category" data-category="-1">XXXX</h3>

    <div id="edit-category-modal" class="modal fade" tabindex="-1" aria-hidden="true" _="
    on hidden.bs.modal
      set #category-edit.value to ''
  ">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-body">
            <input id="category-edit" type="text" class="form-control">
          </div>

          <div class="modal-footer">
            <button id="discard-button" type="button" class="btn btn-secondary" _="
                on click
                  set #category-edit.value to ''
                  call bootstrap.Modal.getInstance(#edit-category-modal).hide()
              ">
              Discard
            </button>

            <button id="apply-button" type="button" class="btn btn-primary" _="
                on click
                  set categoryInput to document.getElementById('category-edit')
                  set appliedValue to value of categoryInput
                  log appliedValue
                  call updateCategory(appliedValue)
                  call bootstrap.Modal.getInstance(#edit-category-modal).hide()
              ">
              Apply
            </button>
          </div>
        </div>
      </div>
    </div>

    <button class="btn primary" _="install EditCategory">
      Edit
    </button>


    <div _="install Category(d: 1)" class="clickable">⇢</div>
  </div>
  <div id="wrapper" class="d-flex justify-content-center">
    <div class="d-flex flex-column pt-4 pb-1 text-center justify-content-between days">
      <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span>
      <span>8</span><span>9</span><span>10</span><span>11</span><span>12</span><span>13</span><span>14</span>
      <span>15</span><span>16</span><span>17</span><span>18</span><span>19</span><span>20</span><span>21</span>
      <span>22</span><span>23</span><span>24</span><span>25</span><span>26</span><span>27</span><span>28</span>
      <span>29</span><span>30</span><span>31</span>
    </div>
    <div id="pixels" class="d-flex"></div>
  </div>
  <div class="d-flex justify-content-center py-4">
    <div _="install Color(c: 1)" class="clickable"><i class="icon icon-2xl color-1"></i></div>
    <div _="install Color(c: 2)" class="clickable"><i class="icon icon-2xl color-2"></i></div>
    <div _="install Color(c: 3)" class="clickable"><i class="icon icon-2xl color-3"></i></div>
    <div _="install Color(c: 4)" class="clickable"><i class="icon icon-2xl color-4"></i></div>
    <div _="install Color(c: 5)" class="clickable"><i class="icon icon-2xl color-5"></i></div>
    <div _="install Color(c: 6)" class="clickable"><i class="icon icon-2xl color-6"></i></div>
    <div _="install Color(c: 7)" class="clickable"><i class="icon icon-2xl color-7"></i></div>
    <div _="install Color(c: 8)" class="clickable"><i class="icon icon-2xl color-8"></i></div>
    <div _="install Color(c: 9)" class="clickable"><i class="icon icon-2xl color-9"></i></div>
    <div _="install Color(c: 10)" class="clickable"><i class="icon icon-2xl color-10"></i></div>
    <div _="install Color(c: 0)" class="clickable"><i class="twa twa-2x twa-wastebasket"></i></div>
  </div>
  <div class="d-flex justify-content-center justify-content-evenly mx-auto mb-3" style="width: 20em;">
    <a class="text-muted clickable"
      _="on click get prompt('Paste exported data here:') js(it) if(it) { localStorage.setItem('pixels', it); location.reload(); } end">Import</a>
    <a class="text-muted clickable"
      _="on click js return localStorage.getItem('pixels') end get prompt('You can copy the following text and import it on another device.', it)">Export</a>
    <a class="text-muted clickable"
      _="on click get confirm('Are you sure you want to clear your data?') js(it) if(it) { localStorage.removeItem('pixels'); location.reload(); } end">Clear</a>
    <a class="text-muted clickable"
      _="on click alert('Keep track of whatever you want in a year using pixels! Data is stored on your device, and can be imported and exported. Created by Jonathan Peacher.')">About</a>
  </div>
  <div class="d-flex justify-content-center justify-content-evenly mx-auto mb-5">
    <p>
      Made with <i class="twa twa-red-heart"></i> by
      <a href="https://www.djpeacher.com" target="_blank">Jonathan Peacher</a>
      and
      <a href="https://www.hierwonisch.at" target="_blank">Jakob Wonisch</a>
    </p>
  </div>
  <script>
    function save() {
      const colors = Array.prototype.slice.call(document.body.getElementsByTagName("i")).map(function (e) {
        return e.getAttribute('data-color')
      }).join('');

      saveColors(getYear(), getCategory(), colors);
    }

    function calcDayOfYear(year, month, day) {
      // https://stackoverflow.com/questions/8619879/javascript-calculate-the-day-of-the-year-1-366
      const now = new Date(year, month, day);
      const start = new Date(year, 0, 0);
      const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
      const oneDay = 1000 * 60 * 60 * 24;
      return Math.floor(diff / oneDay);
    }

    function changeYear(d) {
      setYear((Number(getYear()) + d).toString());
      render();
    }

    function changeCategory(d) {
      setCategory(getCategory() + d);
      render();
    }

    function updateCategory(text) {
      console.log("update: ", text);
      saveCategory(getYear(), getCategory(), text);
      render();
    }

    let initialRender = true;

    function render() {
      const year = getYear();
      const category = getCategory();
      const colors = loadColors(year, category);

      const pixelWrapperElement = document.getElementById("pixels");

      // clear wrapper
      pixelWrapperElement.innerHTML = '';

      // Render calendar.
      const monthNames = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
      [...Array(12)].forEach((_, month) => {
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const monthPixels = [...Array(daysInMonth)].map((_, day) => {
          const dayOfYear = calcDayOfYear(year, month, day);
          const color = colors[dayOfYear] || 0;
          return `<div _='install Pixel'><i class='clickable icon overflow-hidden bg-blend-multiply rounded-5 color-${color}' data-color='${color}'></i></div>`
        }).join("");
        const title = `<div class="text-center">${monthNames[month]}</div>`;
        document.getElementById("title").innerText = `${year}`;
        document.getElementById("category").innerText = loadCategories(year)[category] ?? `Category ${category}`;
        document.getElementById("category").dataset.category = category;
        pixelWrapperElement.insertAdjacentHTML('beforeend', `<div class='d-flex flex-column'>${title}${monthPixels}</div>`);
      });

      if (!initialRender) {
        // reinstall behaviors
        _hyperscript.processNode(pixelWrapperElement);
      }

      initialRender = false;
    }

    render();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
</body>

</html>